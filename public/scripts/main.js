/**
 *
 * Author:  Lisa Irwin
 *
 * Title:  Ratings App
 * Date:  Dec. 6, 2015
 *
 * Credit:  Built this Demo using React Tutorial: Comments App
 * https://facebook.github.io/react/docs/tutorial.html
 *
 * Credit: images/stars=sprite.png
 * from https://images-na.ssl-images-amazon.com/images/G/01/x-locale/common/customer-reviews/RYP_mobile_spritex2-v8._V316463287_.png
 */


function formatDate(date) {
  var monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  var d = new Date(date),
      month = monthNames[d.getMonth()],
      day = '' + d.getDate(),
      year = d.getFullYear();

  return month + ' ' + day + ', ' + year;
}

class StarList extends React.Component {
  constructor(props) {
    super(props);

    this.state = {
      active: -1 //index for highest active index in startNodes array, zero-based
    }
  }

  clickHandler(index) {
    //console.log(index);

    this.setState({
      active: index
    });

    this.props.onClick(index + 1);

  }

  mouseEnterHandler(index) {
    //console.log(index);

    this.setState({active: index });

  }

  mouseLeaveHandler() {
    this.setState({active: -1});
  }


  render() {
    var starNodes = [];

    for (var i = 0; i < 5; i++) {
      var displayRating = i + 1;

      var highlight = i < this.props.numStars ? 'highlight' : '';
      var hover = i <= this.state.active ? 'hover' : '';

      starNodes.push(<div className={"big-star rating-" + displayRating + " " + highlight + " " + hover}
                          key={i}
                          onMouseEnter={this.mouseEnterHandler.bind(this, i)}
                          onMouseLeave={this.mouseLeaveHandler.bind(this, i)}
                          onClick={this.clickHandler.bind(this, i)}

          >

      </div>);
    }

    return (
        <div className="stars-container">
          {starNodes}
          <div className="clear"></div>
        </div>
    );
  }
}

class Rating extends React.Component {
  constructor(props) {
    super(props);

    this.state = {
      showForm: false
    }
  }

  onClickHandler(numStars) {
    this.setState({
          showForm: true
        }
    );

    var date = Date.now();

    this.props.onRatingSubmit({
          id: this.props.id,
          numStars: numStars,
          date: date
    });
  }

  hideForm(){
    this.setState({
          showForm: false
    });
  }

  rawMarkup() {
    var rawMarkup = marked(this.props.children.toString(), {sanitize: true});
    return { __html: rawMarkup };
  }

  render() {
    var date = this.props.date ? formatDate(parseInt(this.props.date, 10)) : null;

    var text = this.props.children ? <span dangerouslySetInnerHTML={this.rawMarkup()} /> : null;
    var title = this.props.title ? <h3 className='title'>{this.props.title}</h3> : null;

    var posted = this.props.date ? <h4>Posted on {date.toString()}</h4> : null;

    var imageStyle = this.props.image ? {
      'backgroundImage': 'url(' + this.props.image + ')'
    } : {};

    var reviewForm = this.state.showForm ? <RatingForm id={this.props.id}
                                                       onRatingSubmit={this.props.onRatingSubmit}
                                                       numStars={this.props.numStars}
                                                       hideForm={this.hideForm.bind(this)}
                                            /> : null;

    return (
      <div className="rating">
        <div className="item-image"  style={imageStyle} />
        <div className="item-content">
          <h2 className="item-name">
            {this.props.name} <span className="item-brand">made by <a href='' >{this.props.brand}</a></span>
          </h2>

          {posted}
          <StarList numStars={this.props.numStars} onClick={this.onClickHandler.bind(this)} />
          {title}
          {text}
          {reviewForm}
        </div>
        <div className="clear"></div>
      </div>
    );
  }
}

class RatingBox extends React.Component {
  constructor(props) {
    super(props);

    this.state = {
      data: []
    }
  }

  loadRatingsFromServer() {
    $.ajax({
      url: this.props.url,
      dataType: 'json',
      cache: false,
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  }

  handleRatingSubmit(rating) {

    function replaceRatingInData(rating, ratings) {
      for (var i = 0; i < ratings.length; i++) {
        var el = ratings[i];
        if (rating.id === el.id) {
          _.extend(ratings[i], rating);
          break;
        }
      }

    }

    var ratings = this.state.data;

    replaceRatingInData(rating, ratings);

    // Optimistically set an id on the new rating. It will be replaced by an
    // id generated by the server. In a production application you would likely
    // not use Date.now() for this and would have a more robust system in place.

    this.setState({data: ratings});

    $.ajax({
      url: this.props.url,
      dataType: 'json',
      type: 'POST',
      data: {
        ratings: ratings
      },
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        this.setState({data: ratings});
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  }


  componentDidMount() {
    this.loadRatingsFromServer.bind(this)();
    setInterval(this.loadRatingsFromServer.bind(this), this.props.pollInterval);
  }

  render() {
    return (
      <div className="ratingBox">
        <h1>My Beer Ratings</h1>
        <RatingList data={this.state.data} onRatingSubmit={this.handleRatingSubmit.bind(this)}/>
      </div>
    );
  }
}

class RatingList extends React.Component {
  render() {
    var onRatingSubmit = this.props.onRatingSubmit;
    var ratingNodes = this.props.data.map(function(rating) {
      return (
        <Rating key={rating.id}
                id={rating.id}
                image={rating.image}
                brand={rating.brand}
                name={rating.name}
                author={rating.author}
                numStars={rating.numStars}
                title={rating.title}
                onRatingSubmit={onRatingSubmit}
                date={rating.date}
            >
          {rating.text}
        </Rating>
      );
    });

    return (
      <div className="ratingList">
        {ratingNodes}
      </div>
    );
  }
}

class RatingForm extends React.Component {
  constructor(props) {
    super(props);

    this.state = {
      title : '',
      text: ''
    }
  }

  handleTitleChange(e) {
    this.setState({title: e.target.value});
  }

  handleTextChange(e) {
    this.setState({text: e.target.value});
  }

  handleSubmit(e) {
    e.preventDefault();
    var title = this.state.title.trim();
    var text = this.state.text.trim();

    //this.props.onRatingSubmit({title: title, text: text});
    this.setState({title: '', text: ''});

    var date = Date.now();

    this.props.onRatingSubmit({
          title: title,
          text: text,
          id: this.props.id,
          numStars: this.props.numStars,
          date: date
        }
    );

    this.props.hideForm();
  }

  cancelSubmit(e){
    e.preventDefault();

    this.setState({title: '', text: ''});

    this.props.onRatingSubmit({
          title: '',
          text: '',
          id: this.props.id,
          numStars: '0',
          date: ''
    });

    this.props.hideForm();

  }


  render() {
    return (
      <form className="ratingForm" onSubmit={this.handleSubmit.bind(this)}>
        <textarea placeholder="Rating Comments (Optional)"
                  value={this.state.text}
                  onChange={this.handleTextChange.bind(this)}
            />
        <input
            type="text"
            placeholder="Headline for Your Rating"
            value={this.state.title}
            onChange={this.handleTitleChange.bind(this)}
            />
        <input type="submit" value="Post" />
        <button onClick={this.cancelSubmit.bind(this)}>Cancel</button>
      </form>
    );
  }
}

ReactDOM.render(
  <RatingBox url="/api/ratings" pollInterval={2000} />,
  document.getElementById('content')
);
